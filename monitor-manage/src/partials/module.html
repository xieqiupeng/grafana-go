<div align="center" ng-controller="ctrl.monitorManageController">

        <input type="text" class="bigtext" name="searchTaskName" id="searchTaskName" placeholder=" 根据任务名称模糊查找" ng-model="searchTaskName"></input>
        <input type="button" value="搜索" ng-click="searchFunction(ctrl.serverHost)" />
        <label hidden id="serverHost">{{ctrl.serverHost}}</label>
        <input type="button" value="新增" id="showAddMonitorTaskModal" />

    <br/>
    <table border="2" width="100%" align="center">
        <tr >
            <td align="center">序号</td>
            <td align="center">任务Id</td>
            <td align="center">任务名称</td>
            <td align="center">状态</td>
            <td align="center">数据源</td>
            <td align="center">tomcat服务器</td>
            <td align="center">创建时间</td>
            <td align="center">更新时间</td>
            <td align="center" colspan="3">操作</td>
        </tr>
        <tr ng-repeat="task in taskArray">
            <td>{{$index+1}}</td>
            <td>{{task.id}}</td>
            <td>{{task.taskName}}</td>
            <td>{{task.status}}</td>
            <td>数据源Ip:{{task.dataSourceServerIp}}:&nbsp;&nbsp;文件位置:{{task.dataSourceLog}}</td>
            <td>{{task.tomcatServerHost}}</td>
            <td>{{task.createTime| date:"yyyy-MM-dd HH:mm:ss"}}</td>
            <td>{{task.updateTime| date:"yyyy-MM-dd HH:mm:ss"}}</td>
            <td  align="center">
                <input type="button" value="暂停" ng-if="task.status=='启动'" class="btn btn-primary" ng-click="startOrPauseTaskFuction(ctrl.serverHost,task.taskName,1)"/>
                <input type="button" value="启动" ng-if="task.status=='暂停'" class="btn btn-primary" ng-click="startOrPauseTaskFuction(ctrl.serverHost,task.taskName,0)"/>
            </td>
            <td  align="center"><input type="button" value="编辑" class="btn btn-primary" id="{{task.taskName}}" onclick="showEditMonitorTaskDialog(this.id)"/></td>
            <!--<td  align="center"><input type="button" value="编辑" class="btn btn-primary" ng-click="editTask(task.id)"/></td>-->
            <td  align="center"><input type="button" value="删除" class="btn btn-primary" ng-click="deleteTaskFunction(ctrl.serverHost,task.taskName)"/></td>
        </tr>
    </table>
    <br/>

    共{{total}}条&nbsp;&nbsp;
    第{{pageNum}}/{{pages}}页
    <input id="lastpage" class="btn btn-primary" type="button" ng-disabled="!hasPreviousPage" ng-click="lastPageFunction(ctrl.serverHost)" value="上一页">
    <input id="nextpage" class="btn btn-primary" type="button" ng-disabled="!hasNextPage" ng-click="nextPageFunction(ctrl.serverHost)" value="下一页">
    每页显示:
    <select ng-model="pageSize" ng-init="pageSize='10'" ng-change="selectChangePageSize()"  size="1" style="width: auto">
        <option value="10">10
        <option value="15">15
        <option value="20">20
    </select>条
    <div id="monitorTaskDialog" title="编辑监控任务" style="background-color: #4cae4c">
        <div class="row" style="border-style:solid; border-width:1px; border-color:#00F" >
            <div class="col-md-6">

                <label for="taskName">任务名称:</label>
                <input type="text" name="taskName" ng-modal="taskName" id="taskName" style="width: 100%" placeholder="请填写任务名称"  >
                <label for="dataSourceServerIp">数据源Ip:</label>
                <input type="text" name="dataSourceServerIp" id="dataSourceServerIp" style="width: 100%" value="" placeholder="请填写数据源ip,多个用英文逗号分隔">
                <label for="dataSourceLog">数据源文件位置:</label>
                <input type="text" name="dataSourceLog" id="dataSourceLog" style="width: 100%" value="" placeholder="请填写数据源文件位置" >
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label >是否为tomcat服务器:</label>
                    <input type="radio" name="isMonitorTomcatServer"  value="1" checked onclick="changeIsMonitorTomcatServer(1)">非tomcat
                    <input type="radio" name="isMonitorTomcatServer" value="0" onclick="changeIsMonitorTomcatServer(0)">是tomcat
                </div>

                <div class="form-group" id="tomcatServerHostDiv" style="display: none">
                    <label for="tomcatServerHost">tomcat服务器地址:</label>
                    <input type="text" name="tomcatServerHost" id="tomcatServerHost" style="width: 100%" value="" placeholder="请输入tomcat地址(ip和port),多个用英文逗号分隔">
                </div>
            </div>
        </div>
        <br/>
        <div class="row" style="border-style:solid; border-width:1px; border-color:#00F">
            <div class="col-md-6">
                <select name="template" id="template" size="1" style="width: auto">
                    <option value="0" selected>普通切分模板
                </select>
                <br/>
                分隔符是否为正则:
                <input type="radio" name="isRegex"  value="false" >非正则
                <input type="radio" name="isRegex"  value="true" >是正则
                <br/>
                分隔符是否为有序:
                <input type="radio" name="isOrder"  value="false" >无序
                <input type="radio" name="isOrder" value="true" >有序
            </div>
            <div class="col-md-6">
                <input type="button" value="新增分隔符" onclick="addSeparatorKey()" />
                <table border="2"  id="separatorKeysTable">
                    <tr>
                        <th>分隔符</th>
                        <th>操作</th>
                    </tr>
                </table>
            </div>
        </div>
        <br/>
        <div class="row" style="border-style:solid; border-width:1px; border-color:#00F">
            <div class="col-md-12">
                <!--<label><b>填写结果列，以行分隔。每行由columnSeq,columnName,columnType,format,tagOrField构成。
                    1、columnSeq起始为0；<br/>
                    2、columnType为boolean,long, double, date之一；<br/>
                    3、format可以为空串；<br/>
                    4、tagOrField为tag或field。
                </b></label>
                <textarea cols="83" rows="2" id="resultTextArea" placeholder="每行由columnSeq,columnName,columnType,format,tagOrField构成"></textarea>-->

                <input type="button" value="新增结果列" onclick="addResultColumn()" />
                <table border="2" align="left" id="resultColumnTable">
                    <tr>
                        <th>列索引(从0起始)</th>
                        <th>列名称</th>
                        <th>列类型</th>
                        <th>格式化(可为空)</th>
                        <th>标签还是值</th>
                        <th>操作</th>
                    </tr>
                </table>
            </div>
        </div>
        <br/>
        <div class="row" style="border-style:solid; border-width:1px; border-color:#00F">
            <div class="col-md-12">
                <label for="dataSourceLogSample">输入数据源内容样例，然后点击<input type="button" value="执行解析"  onclick="dataClean()"/></label>
                <textarea rows="1" cols="20" name="dataSourceLogSample" id="dataSourceLogSample" style="width: 100%" placeholder="请输入一行完整的数据源内容" ></textarea>
            </div>
            <br/>

            <br/>
            <div class="col-md-12" align="center">
                <label for="dataSourceLogSampleResultTable">输出数据源解析结果:</label>
                <table border="2" id="dataSourceLogSampleResultTable" align="center">
                    <tr>
                        <th>列名称</th>
                        <th>列类型</th>
                        <th>数据源内容</th>
                    </tr>
                </table>
            </div>
        </div>
        <div align="center">
            <input type="button" value="保存" class="btn btn-primary" ng-click="searchFunction(ctrl.serverHost)" onclick="saveOrUpdateMonitorTask()"/>
            <input type="button" value="取消" class="btn btn-primary" onclick="closeAddMonitorTaskDialog()"/>
        </div>
        <label hidden id="saveOrUpdateContextPath"></label>
    </div>
</div>


<script type="text/javascript">
    //结果列索引
    var resultColumnIndex=0;
    //分隔符索引
    var separatorKeyIndex=0;
    //解析结果索引
    var dataSourceLogSampleResultIndex=0;

    //数据清洗
    function dataClean(){

        //切割模板类型
        var template=$("#template").val();
        //是否为正则
        var isRegex=$("input[name='isRegex']:checked").val();
        //是否为有序
        var isOrder=$("input[name='isOrder']:checked").val();

        //请填写分隔符
        var separatorKeys=new Array();
        $(".separatorKeyTr").each(function(){
            var separatorKeyObject=getSeparatorKeyObject($(this).attr('id').substr('separatorKeyTr'.length));
            separatorKeys.push(separatorKeyObject);
        });

        //请填写结果列
        var resultColumns=new Array();
        $(".resultColumnTr").each(function(){
            var resultColumnObject=getResultColumnObject($(this).attr('id').substr('resultColumnTr'.length));
            resultColumns.push(resultColumnObject);
        });

        //获得切割模板对象
        var cutTemplateObject=getCutTemplateObject(template,isOrder,isRegex,separatorKeys,resultColumns);



        //传输数据
        var dataCleanRule=JSON.stringify(cutTemplateObject);
        var data="data="+document.getElementById('dataSourceLogSample').value+"&dataCleanRule="+dataCleanRule;
        //服务器地址
        var serverHost=document.getElementById('serverHost').innerHTML;
        $.ajax({
            "type": "post",
            "dataType": "json",
            "data":data,
            "url" : serverHost+"monitorTask/dataClean",
            "success": function(result)
            {

                if(result.resultCode==0){
                    for(var i=0;i< result.data.length;i++){
                        console.log(result.data[i].columnName+" "+result.data[i].columnFormat+" "+result.data[i].columnExampleValue);
                        addDataSourceLogSampleResult(result.data[i].columnName,result.data[i].columnFormat,result.data[i].columnExampleValue);
                    }
                }else{
                    alert('解析失败!具体原因：'+result.resultMsg);
                }
            }
        });

    }

    //新增分隔符
    function addDataSourceLogSampleResult(columnName,columnFormat,columnExampleValue) {
        $("#dataSourceLogSampleResultTable").append(
            '<tr class="dataSourceLogSampleResultTr">' +
            '   <td>'+columnName+'</td>' +
            '   <td>'+columnFormat+'</td>' +
            '   <td>'+columnExampleValue+'</td>' +
            '</tr>');
    }

    //新增分隔符
    function addSeparatorKey() {
        $("#separatorKeysTable").append(
            '<tr id="separatorKeyTr'+separatorKeyIndex+'" class="separatorKeyTr">' +
            '   <td><input id="separatorKey'+separatorKeyIndex+'" type="text" style="width: 100%;"/></td>' +
            '   <td><input type="button" value="删除" onclick="removeSeparatorKey('+separatorKeyIndex+')" ></input></td>\n' +
            '</tr>');
        return separatorKeyIndex++;
    }

    //新增结果列
    function addResultColumn() {
        $("#resultColumnTable").append(
            '<tr id="resultColumnTr'+resultColumnIndex+'" class="resultColumnTr">' +
            '   <td><input id="columnSeq'+resultColumnIndex+'" type="text" style="width: 118px;"/></td>' +
            '   <td><input id="columnName'+resultColumnIndex+'" type="text" style="width: 138px;"/></td>\n' +
            '   <td>' +
            '       <select id="columnType'+resultColumnIndex+'" size="1" style="width: 100%">\n' +
            '            <option value="boolean" selected>boolean</option>\n' +
            '            <option value="long">long</option>\n' +
            '            <option value="double">double</option>\n' +
            '            <option value="string">string</option>\n' +
            '            <option value="date">date</option>\n' +
            '       </select>\n' +
            '   </td>\n' +
            '   <td><input id="format'+resultColumnIndex+'" type="text" /></td>\n' +
            '   <td>\n' +
            '       <select id="tagOrField'+resultColumnIndex+'" size="1" style="width: 100%">\n' +
            '            <option value="0" selected>tag</option>\n' +
            '            <option value="1">field</option>\n' +
            '       </select>\n' +
            '   </td>\n' +
            '   <td><input type="button" value="删除" onclick="removeResultColumn('+resultColumnIndex+')"></input></td>\n' +
            '</tr>');
        return resultColumnIndex++;
    }

    function removeSeparatorKey(separatorKey){
        $("#separatorKeyTr"+separatorKey).remove();
    }

    function removeResultColumn(resultColumn){
        $("#resultColumnTr"+resultColumn).remove();
    }

    function showEditMonitorTaskDialog(taskName) {
        //清空表单
        clearMonitorTaskDialog();

        //清除上一次解析结果
        $(".dataSourceLogSampleResultTr").remove();

        //服务器地址
        var serverHost=document.getElementById('serverHost').innerHTML;
        $("#saveOrUpdateContextPath").html('monitorTask/editTask');


        $.ajax({
            "type": "get",
            "dataType": "json",
            "data":{'taskName':taskName},
            "url" : serverHost+"monitorTask/getTaskByTaskName",
            "success": function(result)
            {
                if(result.resultCode==0){

                    result.data.cutTemplate=JSON.parse(result.data.cutTemplate);
                    //任务名称
                    document.getElementById('taskName').value=result.data.taskName;
                    $("#taskName").attr('disabled','disabled');

                    //数据源Ip
                    document.getElementById('dataSourceServerIp').value=result.data.dataSourceServerIp;
                    //数据源文件位置
                    document.getElementById('dataSourceLog').value=result.data.dataSourceLog;
                    //是否为tomcat服务器 =1非tomcat
                    setCheckRegex(result.data.isMonitorTomcatServer==1?false:true,"isMonitorTomcatServer");
                    changeIsMonitorTomcatServer(result.data.isMonitorTomcatServer);


                    document.getElementById('tomcatServerHost').value=result.data.tomcatServerHost;

                    //设置切割模板类型
                    $("#template").val(result.data.cutTemplate.template);
                    //是否为正则
                    setCheckRegex(result.data.cutTemplate.separator.isRegex,"isRegex");
                    //是否为有序
                    setCheckRegex(result.data.cutTemplate.separator.isOrder,"isOrder");


                    //分隔符数组
                    var separatorKeys=result.data.cutTemplate.separator.separatorKeys;
                    //新增分隔符
                    for(var i=0;i<separatorKeys.length;i++){
                        var currentSeparatorKeyIndex=addSeparatorKey();
                        initSeparatorKey(currentSeparatorKeyIndex,separatorKeys[i]);
                    }
                    //结果列数组
                    var resultColumns=result.data.cutTemplate.resultColumns;
                    //新增结果列
                    for(var i=0;i<resultColumns.length;i++){
                        var currentResultColumnIndex=addResultColumn();
                        initResultColumn(currentResultColumnIndex,resultColumns[i]);
                    }

                    $("#monitorTaskDialog" ).dialog( "open" );


                }else{
                    alert('后台服务失败!具体原因：'+result.resultMsg);
                }
            }
        });


    }

    //设置isRegex
    function setCheckRegex(checkFlag,checkName){
        if(checkFlag==true){
            //alert(checkFlag+" "+checkName);
            $("input[name="+checkName+"]:eq(1)").prop("checked","checked");
            $("input[name="+checkName+"]:eq(0)").removeAttr("checked");
        }else if(checkFlag==false){
            //alert(checkFlag+" "+checkName);
            $("input[name="+checkName+"]:eq(0)").prop("checked","checked");
            $("input[name="+checkName+"]:eq(1)").removeAttr("checked");
        }
    }
    function initSeparatorKey(currentSeparatorKeyIndex,separatorKey){
        //初始化分隔符
        document.getElementById('separatorKey'+currentSeparatorKeyIndex).value=separatorKey;
    }

    function initResultColumn(currentResultColumnIndex,resultColumnObject){
        //初始化结果列
        document.getElementById('columnSeq'+currentResultColumnIndex).value=resultColumnObject.columnSeq;
        document.getElementById('columnName'+currentResultColumnIndex).value=resultColumnObject.columnName;
        $("#columnType"+currentResultColumnIndex).val(resultColumnObject.columnType);
        document.getElementById('format'+currentResultColumnIndex).value=resultColumnObject.format;
        $("#tagOrField"+currentResultColumnIndex).val(resultColumnObject.tagOrField);
    }


    function closeAddMonitorTaskDialog() {
        $( "#monitorTaskDialog" ).dialog( "close" );
    }
    function changeIsMonitorTomcatServer(judgeIsMonitorTomcatServer){
        if(judgeIsMonitorTomcatServer==0){
            $("#tomcatServerHostDiv").css({"display":"block"});
        }else{
            $("#tomcatServerHostDiv").css({"display":"none"});
        }
    }

    //获得结果列对象
    function getResultColumnObject(resultColumnIndex){
        var resultColumnObject=new Object();
        resultColumnObject.columnSeq=parseInt($("#columnSeq"+resultColumnIndex).val());
        resultColumnObject.columnName=$("#columnName"+resultColumnIndex).val();
        resultColumnObject.columnType=$("#columnType"+resultColumnIndex).val();
        resultColumnObject.format=$("#format"+resultColumnIndex).val();
        resultColumnObject.tagOrField=parseInt($("#tagOrField"+resultColumnIndex).val());
        console.log('resultColumnIndex '+resultColumnIndex+"  "+JSON.stringify(resultColumnObject));
        return resultColumnObject;
    }

    //获得分隔符对象
    function getSeparatorKeyObject(separatorKeyIndex){
        return $("#separatorKey"+separatorKeyIndex).val();
    }



    //保存或者更新
    function saveOrUpdateMonitorTask() {

        //任务名称
        var taskName=document.getElementById('taskName').value;
        if(taskName==null||taskName.trim()==''){
            alert('请填写任务名称!');
            return ;
        }
        //数据源Ip
        var dataSourceServerIp=document.getElementById('dataSourceServerIp').value;
        if(dataSourceServerIp==null||dataSourceServerIp.trim()==''){
            alert('请填写数据源Ip!');
            return ;
        }
        //数据源文件位置
        var dataSourceLog=document.getElementById('dataSourceLog').value;
        if(dataSourceLog==null||dataSourceLog.trim()==''){
            alert('请填写数据源文件位置!');
            return ;
        }

        //是否为tomcat服务器
        var isMonitorTomcatServer=$("input[name='isMonitorTomcatServer']:checked").val();
        var tomcatServerHost='';
        if(isMonitorTomcatServer==0){
            tomcatServerHost=document.getElementById('tomcatServerHost').value;
            if(tomcatServerHost==null||tomcatServerHost.trim()==''){
                alert('请填写tomcat服务器地址!');
                return ;
            }
        }


        //切割模板类型
        var template=$("#template").val();
        //是否为正则
        var isRegex=$("input[name='isRegex']:checked").val();
        //是否为有序
        var isOrder=$("input[name='isOrder']:checked").val();

        //请填写分隔符
        var separatorKeys=new Array();
        $(".separatorKeyTr").each(function(){
            var separatorKeyObject=getSeparatorKeyObject($(this).attr('id').substr('separatorKeyTr'.length));
            separatorKeys.push(separatorKeyObject);
        });

        //请填写结果列
        var resultColumns=new Array();
        $(".resultColumnTr").each(function(){
            var resultColumnObject=getResultColumnObject($(this).attr('id').substr('resultColumnTr'.length));
            resultColumns.push(resultColumnObject);
        });

        //获得切割模板对象
        var cutTemplateObject=getCutTemplateObject(template,isOrder,isRegex,separatorKeys,resultColumns);
        //服务器地址
        var serverHost=document.getElementById('serverHost').innerHTML;

        var saveOrUpdateContextPath=$("#saveOrUpdateContextPath").html();
        //传输数据
        var data=JSON.stringify({
            taskName:taskName,
            dataSourceServerIp:dataSourceServerIp,
            dataSourceLog:dataSourceLog,
            isMonitorTomcatServer:isMonitorTomcatServer,
            tomcatServerHost:tomcatServerHost,
            cutTemplate:cutTemplateObject
        });
        console.log('data:'+data);
        $.ajax({
            "type": "post",
            "dataType": "json",
            "data":data,
            "contentType": "application/json; charset=utf-8",
            "url" : serverHost+saveOrUpdateContextPath,
            "success": function(result)
            {
                if(result.resultCode==0){
                    alert('保存成功!');
                    $( "#monitorTaskDialog" ).dialog( "close" );
                }else{
                    alert('保存失败!具体原因：'+result.resultMsg);
                }
            }
        });
    }

    function clearMonitorTaskDialog() {

        //任务名称
        document.getElementById('taskName').value='';
        //数据源Ip
        document.getElementById('dataSourceServerIp').value='';
        //数据源文件位置
        document.getElementById('dataSourceLog').value='';

        document.getElementById('tomcatServerHost').value='';

        //切割模板类型-默认普通文本类型
        $("input[name='template']").val(0);
//        //非正则
//        $("input[name='isRegex']").val(false);
//        //无序
//        $("input[name='isOrder']").val(false);

        setCheckRegex(false,"isMonitorTomcatServer");

        //是否为正则
        setCheckRegex(false,"isRegex");
        //是否为有序
        setCheckRegex(false,"isOrder");




        //清除分隔符
        $(".separatorKeyTr").each(function(){
            removeSeparatorKey($(this).attr('id').substr("separatorKeyTr".length));
        });

        //清除结果列
        $(".resultColumnTr").each(function(){
            removeResultColumn($(this).attr('id').substr("resultColumnTr".length));
        });

        
    }
    
    function getCutTemplateObject(template,isOrder,isRegex,separatorKeys,resultColumns) {
        //拼接切割模板
        var cutTemplate=new Object();
        cutTemplate.template=template;

        var separatorObject=new Object();
        separatorObject.isOrder=(isOrder=='false'?false:true);
        separatorObject.isRegex=(isRegex=='false'?false:true);
        separatorObject.separatorKeys=separatorKeys;

        cutTemplate.separator=separatorObject;
        cutTemplate.resultColumns=resultColumns;
        return cutTemplate;
    }

     //显示新增窗口
    $(function() {
        $( "#monitorTaskDialog" ).dialog({
            autoOpen: false,
            modal: true,
            height: 500,
            width: 750
        });

        $( "#showAddMonitorTaskModal" ).click(function() {
            //清空表单
             clearMonitorTaskDialog();
            //清除上一次解析结果
            $(".dataSourceLogSampleResultTr").remove();
            $("#saveOrUpdateContextPath").html('monitorTask/addTask');
            $("#taskName").removeAttr('disabled','disabled');
            $( "#monitorTaskDialog" ).dialog( "open" );
        });

    });
</script>





